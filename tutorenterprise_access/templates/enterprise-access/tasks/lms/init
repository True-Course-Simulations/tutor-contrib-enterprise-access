dockerize -wait tcp://{{ MYSQL_HOST }}:{{ MYSQL_PORT }} -timeout 20s

echo "enterprise-access lms init: syncing service user email"
./manage.py lms shell -c \
  "from django.contrib.auth import get_user_model; \
   get_user_model().objects.filter(username='enterprise-access') \
   .exclude(email='enterprise-access@openedx') \
   .update(email='enterprise-access@openedx')"

echo "enterprise-access lms init: ensuring service user exists"
./manage.py lms manage_user enterprise-access enterprise-access@openedx --staff --superuser --unusable-password

# Development clients
echo "enterprise-access lms init: creating dev OAuth clients"
./manage.py lms create_dot_application \
  --grant-type client-credentials \
  --redirect-uris "{% if ENABLE_HTTPS %}https{% else %}http{% endif %}://{{ ENTERPRISE_ACCESS_HOST }}:{{ ENTERPRISE_ACCESS_PORT }}/complete/edx-oauth2/" \
  --client-id {{ ENTERPRISE_ACCESS_OAUTH2_KEY_DEV }} \
  --client-secret {{ ENTERPRISE_ACCESS_OAUTH2_SECRET_DEV }} \
  --scopes user_id \
  --skip-authorization \
  --update \
  enterprise-access-dev \
  enterprise-access

./manage.py lms create_dot_application \
  --grant-type authorization-code \
  --redirect-uris "{% if ENABLE_HTTPS %}https{% else %}http{% endif %}://{{ ENTERPRISE_ACCESS_HOST }}:{{ ENTERPRISE_ACCESS_PORT }}/complete/edx-oauth2/" \
  --client-id {{ ENTERPRISE_ACCESS_OAUTH2_KEY_SSO_DEV }} \
  --client-secret {{ ENTERPRISE_ACCESS_OAUTH2_SECRET_SSO_DEV }} \
  --scopes user_id \
  --skip-authorization \
  --update \
  enterprise-access-sso-dev \
  enterprise-access

# Production clients
echo "enterprise-access lms init: creating prod OAuth clients"
./manage.py lms create_dot_application \
  --grant-type client-credentials \
  --redirect-uris "{% if ENABLE_HTTPS %}https{% else %}http{% endif %}://{{ ENTERPRISE_ACCESS_HOST }}/complete/edx-oauth2/" \
  --client-id {{ ENTERPRISE_ACCESS_OAUTH2_KEY }} \
  --client-secret {{ ENTERPRISE_ACCESS_OAUTH2_SECRET }} \
  --scopes user_id \
  --skip-authorization \
  --update \
  enterprise-access \
  enterprise-access

./manage.py lms create_dot_application \
  --grant-type authorization-code \
  --redirect-uris "{% if ENABLE_HTTPS %}https{% else %}http{% endif %}://{{ ENTERPRISE_ACCESS_HOST }}/complete/edx-oauth2/" \
  --client-id {{ ENTERPRISE_ACCESS_OAUTH2_KEY_SSO }} \
  --client-secret {{ ENTERPRISE_ACCESS_OAUTH2_SECRET_SSO }} \
  --scopes user_id \
  --skip-authorization \
  --update \
  enterprise-access-sso \
  enterprise-access
